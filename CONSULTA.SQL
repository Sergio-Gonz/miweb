DECLARE @FECHA_CIERRE AS dATE = GETDATE(); 

with  USUARIOS AS(
SELECT DISTINCT
MC.[Cod Gte Num]
,MC.Usuario
,MD.[Nombre Agencia]
FROM AV_INFO_MASTER_DATOS MD
INNER JOIN AV_INFO_MASTER_CARTERAS MC
ON MD.[Usuario wind] = MC.Usuario
WHERE MD.[Participa AGIR (S/N)] = 'S' 
)
, GERENTES AS(
SELECT distinct 
T1.COD_GERENTE_NUM,
t1.GNOMBG as Nombre_Gerente,
t1.SSEGME as SEGMENTO_GERENTE,
t1.CDGAGN as COD_AGENCIA,
t2.DSCRPCN_SGMNT AS DESC_GERENTE,
t1.FECHA_ACT
FROM CORPDW_GERENTES t1
inner join CLSFCCN_SGMNTS t2 on t1.SSEGME=t2.CDG_SGMNT
WHERE t1.FECHA_ACT =  (SELECT MAX(FECHA_ACT) FROM CORPDW_GERENTES)
and COD_GERENTE_NUM <>10
and SSEGME in('Q','P')
)
, AGENCIAS AS(
select 
CDGAGN as Codigo_Agencia,
DLRAGN as Nombre_Agencia
from CORPDW_AGENCIAS
Where FECHA_ACT=(select max(FECHA_ACT) from CORPDW_AGENCIAS)
)
, AUX AS (
select 
t2.Codigo_Agencia,
--t2.Nombre_Agencia,
t1.COD_GERENTE_NUM,
t1.Nombre_Gerente,
t1.SEGMENTO_GERENTE,
t1.DESC_GERENTE
from GERENTES t1 
LEFT join AGENCIAS t2 on t1.COD_AGENCIA = t2.Codigo_Agencia
)
, AGENCIAGERENTE AS (
SELECT 
A.Codigo_Agencia
,M.[Nombre Agencia]
,A.COD_GERENTE_NUM
,A.Nombre_Gerente
,A.SEGMENTO_GERENTE
,A.DESC_GERENTE
FROM AUX A
LEFT JOIN 
USUARIOS M
ON A.COD_GERENTE_NUM = M.[Cod Gte Num]
)
, ACTIVOS AS(
select 
t1.FECHA_CIERRE,
t2.ACLINO AS NRO_CLIENTE,
t1.moneda,
t1.Segmento_gerente as segmento_ACTPR,
t2.ACLIGTEID as Cod_gerente,
SUM(T1.SALDO_PUNTA) AS SALDO_ORIGINAL,
t1.NRO_OPERACION 
from CORPDW_OP_ACTIVO_PROCESADO_DIARIO t1
INNER JOIN ODSP_V_COREDBDB2_CLMCLI T2 ON T1.NRO_CLIENTE = T2.ACLINO
WHERE T1.SALDO_PUNTA > 0
AND T1.SEGMENTO_GERENTE IN('E','K','P','Q','S')
AND T1.FECHA_CIERRE =@FECHA_CIERRE
and t2.FECHA_CIERRE =@FECHA_CIERRE
GROUP BY 
t1.FECHA_CIERRE,
t2.ACLINO,
t1.moneda,
t1.Segmento_gerente,
t2.ACLIGTEID,
t1.NRO_OPERACION
)
, ACTIVOS1 AS (
select 
A.FECHA_CIERRE,
A.NRO_CLIENTE,
A.segmento_ACTPR,
A.Cod_Gerente,
A.SALDO_ORIGINAL,
A.NRO_OPERACION,
B.TIPO_CAMBIO_EU,
B.TIPO_CAMBIO,
A.MONEDA
from ACTIVOS A
inner join CORPDW_PARAMETROS B on A.FECHA_CIERRE = B.Fecha_cierre
)
, ACTIVOS2 AS(
select 
A.FECHA_CIERRE,
A.NRO_CLIENTE,
A.segmento_ACTPR,
A.Cod_gerente,
CAST(SUM(CASE 
        WHEN A.MONEDA = 1 then A.Saldo_Original * A.TIPO_CAMBIO 
        WHEN A.MONEDA = 6900 THEN A.Saldo_Original 
        WHEN A.MONEDA = 62 THEN A.Saldo_Original * A.TIPO_CAMBIO_EU 
    END) AS bigint) AS SALDO_PUNTA_PYG,
COUNT (A.NRO_OPERACION) AS CANT_CLIENTES
from ACTIVOS1 A
group by 
A.FECHA_CIERRE,
A.NRO_CLIENTE,
A.segmento_ACTPR,
A.Cod_gerente
)
, ACTIVOSPROCESADOS AS(
select
A.FECHA_CIERRE,
Cartera = 'ACTIVOS',
B.Codigo_Agencia as AGENCIA_GERENTE,
B.[Nombre Agencia] AS AGENCIA,
B.COD_GERENTE_NUM,
B.Nombre_Gerente,
A.SEGMENTO_ACTPR,
B.SEGMENTO_GERENTE AS SEGMENTO,
SUM(A.SALDO_PUNTA_PYG) as SALDO_PUNTA_PYG,
sum(A.CANT_CLIENTES) as CANT_CLIENTES
from ACTIVOS2 A
inner join AGENCIAGERENTE B on A.Cod_gerente = B.COD_GERENTE_NUM
group by
A.FECHA_CIERRE,
B.Codigo_Agencia,
B.[Nombre Agencia],
B.COD_GERENTE_NUM,
B.Nombre_Gerente,
A.SEGMENTO_ACTPR,
B.SEGMENTO_GERENTE
)

select * from ACTIVOSPROCESADOS ORDER BY AGENCIA_GERENTE DESC
